p2p_move_base:
  ros__parameters:
    controller_frequency: 10.0
    planner_patience: 10.0
    oscillation_distance: 5.0
    oscillation_angle: 1.0
    oscillation_patience: 15.0
    controller_patience: 10.0
    no_plan_retry_num: 10
    waiting_patience: 10.0

global_plan_manager:
  ros__parameters:
    global_planner_action_name: "get_dwa_plan"
    global_plan_query_frequency: 5.0

# MID360激光雷达配置 (SLAM建图时使用)
mcl_ip:
  ros__parameters:
    laser:
        odom_type: "wheel_odometry"         # 轮式阿克曼使用轮编码器里程计
        baselink_frame: "base_link"
        num_vertical_scans: 32              # MID360: 32条扫描线
        num_horizontal_scans: 1000          # 水平分辨率
        ground_scan_index: 16               # 地面扫描线索引
        vertical_angle_bottom: -7.0         # MID360: 垂直视角下界
        vertical_angle_top: 52.0            # MID360: 垂直视角上界
        scan_period: 0.1                    # 扫描周期 (100ms = 10Hz)

    imageProjection:
        segment_valid_point_num: 5
        segment_valid_line_num: 2
        segment_theta: 60.0
        maximum_detection_range: 120.0
        distance_for_patch_between_rings: 1.0
        minimum_detection_range: 0.5

mcl_fa:
  ros__parameters:
    featureAssociation:
        edge_threshold: 0.1
        surf_threshold: 0.1
        nearest_feature_search_distance: 3.0
        
sub_maps:
  ros__parameters:
    pose_graph_dir: "/root/dddmr_bags/ackermann_robot_map"  # 修改为你的地图目录
    sub_map_search_radius: 50.0
    sub_map_warmup_trigger_distance: 20.0
    complete_map_voxel_size: 0.4

# MCL 3D定位参数
mcl_3dl:
  ros__parameters:
    init_x: 0.0
    init_y: 0.0
    init_z: 0.0
    init_roll: 0.0
    init_pitch: 0.0
    init_yaw: 0.0
    init_var_x: 2.0
    init_var_y: 2.0
    init_var_z: 0.5
    init_var_roll: 0.1
    init_var_pitch: 0.1
    init_var_yaw: 0.5
    map_frame: "map"
    robot_frame: "base_link"
    odom_frame: "odom"
    map_downsample_x: 0.1
    map_downsample_y: 0.1
    map_downsample_z: 0.1
    map_update_interval_sec: 2
    num_particles: 60

    resample_var_x: 0.2
    resample_var_y: 0.2
    resample_var_z: 0.2
    resample_var_yaw: 0.1
    resample_var_pitch: 0.2
    resample_var_roll: 0.2
    expansion_var_x: 0.5
    expansion_var_y: 0.5
    expansion_var_z: 0.5
    expansion_var_roll: 0.2
    expansion_var_pitch: 0.2
    expansion_var_yaw: 0.2
    match_ratio_thresh: 0.0

    euc_cluster_distance: 0.8
    euc_cluster_min_size: 3
    euc_cluster_max_size: 2400

    knn_num_of_ground_normals: 20

    update_min_d: 0.1
    update_min_a: 0.1

    odom_err_lin_lin: 0.6
    odom_err_lin_ang: 0.3
    odom_err_ang_lin: 0.3
    odom_err_ang_ang: 0.6

    odom_err_integ_lin_tc: 5.0
    odom_err_integ_ang_tc: 10.0

    lpf_step: 2.0
    acc_lpf_step: 128.0

    jump_dist: 1.0
    jump_ang: 1.57

    bias_var_dist: 2.0
    bias_var_ang: 1.57
    tf_tolerance: 0.1
    publish_tf: true

    likelihood:
      num_points_global: 8
      match_dist_min: 0.3
      match_dist_flat: 0.05
      threshold_for_trusted_ground: 6
      radius_of_ground_search: 1.0

# 本地规划器配置
local_planner:
  ros__parameters:
    odom_topic: odom
    forward_prune: 3.0
    backward_prune: 1.0
    heading_tracking_distance: 0.5
    heading_align_angle: 0.5
    prune_plane_timeout: 3.0
    xy_goal_tolerance: 0.3
    yaw_goal_tolerance: 0.3
    controller_frequency: 10.0
    
    # 碰撞检测立方体 (需要根据实际机器人尺寸调整)
    # 假设轮式阿克曼机器人: 长0.9m, 宽0.4m, 高0.5m
    # base_link 在底盘中心
    cuboid:
      flb: [0.45, 0.2, 0.0]   # 前左下角 (x, y, z)
      frb: [0.45, -0.2, 0.0]  # 前右下角
      flt: [0.45, 0.2, 0.5]   # 前左上角
      frt: [0.45, -0.2, 0.5]  # 前右上角
      blb: [-0.45, 0.2, 0.0]  # 后左下角
      brb: [-0.45, -0.2, 0.0] # 后右下角
      blt: [-0.45, 0.2, 0.5]  # 后左上角
      brt: [-0.45, -0.2, 0.5] # 后右上角

# 恢复行为 (卡住时的恢复策略)
recovery_behaviors:
  ros__parameters:
    plugins: ["rotate_inplace"]
    rotate_inplace:
      plugin: "recovery_behaviors::RotateInPlaceBehavior"
      frequency: 10.0
      tolerance: 0.3
      trajectory_generator_name: "ackermann_rotate_inplace"

# 轨迹生成器配置 (这是关键部分！)
# ⚠️ 注意: 当前使用 DDSimpleTrajectoryGeneratorTheory (差分驱动)
# ⚠️ 对于真正的阿克曼机器人，需要替换为 AckermannSimpleTrajectoryGeneratorTheory
trajectory_generators:
  ros__parameters:
    # ============================================
    # TODO: 将以下插件改为阿克曼版本
    # plugins: ["ackermann_simple", "ackermann_rotate_inplace"]
    # ============================================
    
    plugins: ["differential_drive_simple", "differential_drive_rotate_inplace", "differential_drive_rotate_shortest_angle"]
    
    differential_drive_rotate_shortest_angle:
      plugin: "trajectory_generators::DDRotateInplaceTheory"
      controller_frequency: 10.0
      rotation_speed: 0.5
      cuboid:
        flb: [0.45, 0.2, 0.0]
        frb: [0.45, -0.2, 0.0]
        flt: [0.45, 0.2, 0.5]
        frt: [0.45, -0.2, 0.5]
        blb: [-0.45, 0.2, 0.0]
        brb: [-0.45, -0.2, 0.0]
        blt: [-0.45, 0.2, 0.5]
        brt: [-0.45, -0.2, 0.5]

    differential_drive_rotate_inplace:
      plugin: "trajectory_generators::DDRotateInplaceTheory"
      controller_frequency: 10.0
      rotation_speed: 0.5
      cuboid:
        flb: [0.45, 0.2, 0.0]
        frb: [0.45, -0.2, 0.0]
        flt: [0.45, 0.2, 0.5]
        frt: [0.45, -0.2, 0.5]
        blb: [-0.45, 0.2, 0.0]
        brb: [-0.45, -0.2, 0.0]
        blt: [-0.45, 0.2, 0.5]
        brt: [-0.45, -0.2, 0.5]
    
    differential_drive_simple:
      plugin: "trajectory_generators::DDSimpleTrajectoryGeneratorTheory"
      max_vel_x: 1.0
      min_vel_x: 0.1
      max_vel_theta: 0.6
      min_vel_theta: 0.15
      acc_lim_x: 1.0
      acc_lim_theta: 3.0
      deceleration_ratio: 2.0
      max_motor_shaft_rpm: 3000.0
      wheel_diameter: 0.2          # 轮径，需要根据实际调整
      gear_ratio: 1.0
      robot_radius: 0.25
      controller_frequency: 10.0
      sim_time: 2.0

# ============================================
# 以下是建议的阿克曼轨迹生成器配置 (参考)
# 当实现 AckermannSimpleTrajectoryGeneratorTheory 时使用
# ============================================
# ackermann_simple:
#   plugin: "trajectory_generators::AckermannSimpleTrajectoryGeneratorTheory"
#   max_vel_x: 1.5                          # 最大线速度 (m/s)
#   min_vel_x: 0.1
#   max_steering_angle: 0.52                # 最大转向角 (弧度，约30°)
#   min_steering_angle: -0.52
#   wheelbase: 0.35                         # 轴距 (m) - 需要根据实际机器人调整
#   track_width: 0.4                        # 轮距 (m) - 需要根据实际机器人调整
#   max_acceleration: 2.0
#   max_deceleration: 3.0
#   max_steering_rate: 1.0                  # 最大转向角速度
#   
#   cuboid:
#     flb: [0.45, 0.2, 0.0]
#     frb: [0.45, -0.2, 0.0]
#     flt: [0.45, 0.2, 0.5]
#     frt: [0.45, -0.2, 0.5]
#     blb: [-0.45, 0.2, 0.0]
#     brb: [-0.45, -0.2, 0.0]
#     blt: [-0.45, 0.2, 0.5]
#     brt: [-0.45, -0.2, 0.5]
#   
#   controller_frequency: 10.0
#   sim_time: 1.0
#
# ackermann_rotate_inplace:
#   plugin: "trajectory_generators::AckermannRotateInplaceTheory"
#   rotation_speed: 0.3
#   controller_frequency: 10.0
