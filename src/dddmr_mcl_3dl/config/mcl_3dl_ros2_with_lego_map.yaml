# MCL 3DL 配置文件 - 启用lego_map文件夹中的地图
# mcl_3dl_ros2.yaml - Enhanced version with lego_map support

sub_maps:
  ros__parameters:
    # 指向lego_map文件夹中的子地图文件
    pose_graph_dir: "/home/tianbot/dddmr_navigation_ws/src/lego_map/pcd"
    
    # 子地图搜索范围（米）- 适合中等规模场景
    sub_map_search_radius: 50.0
    
    # 触发地图预热的距离（米）
    sub_map_warmup_trigger_distance: 20.0
    
    # 完整地图体素尺寸（米）
    complete_map_voxel_size: 0.25

mcl_3dl:
  ros__parameters:
    # ============================================
    # 初始位置估计 (根据建图起点调整)
    # ============================================
    init_x: 0.0                         # 初始X位置（米）
    init_y: 0.0                         # 初始Y位置（米）
    init_z: 0.0                         # 初始Z位置（米）
    init_roll: 0.0                      # 初始Roll角（弧度）
    init_pitch: 0.0                     # 初始Pitch角（弧度）
    init_yaw: 0.0                       # 初始Yaw角（弧度）
    
    # ============================================
    # 初始不确定度 (影响粒子初始分布范围)
    # ============================================
    init_var_x: 2.0                     # X方向初始方差（米²）
    init_var_y: 2.0                     # Y方向初始方差（米²）
    init_var_z: 3.0                     # Z方向初始方差（米²）
    init_var_roll: 0.1                  # Roll初始方差（弧度²）
    init_var_pitch: 0.1                 # Pitch初始方差（弧度²）
    init_var_yaw: 0.5                   # Yaw初始方差（弧度²）
    
    # ============================================
    # 坐标系配置
    # ============================================
    map_frame: "map"                    # 地图坐标系
    robot_frame: "base_link"            # 机器人基座坐标系
    odom_frame: "odom"                  # 里程计坐标系
    
    # ============================================
    # 地图下采样参数
    # ============================================
    map_downsample_x: 0.1               # X方向下采样（米）
    map_downsample_y: 0.1               # Y方向下采样（米）
    map_downsample_z: 0.1               # Z方向下采样（米）
    map_update_interval_sec: 1          # 地图更新间隔（秒）
    
    # ============================================
    # 粒子滤波参数
    # ============================================
    num_particles: 200                  # 粒子数量
                                        # 建议: 
                                        # - 小场景: 100-200
                                        # - 中场景: 200-500
                                        # - 大场景: 500-1000
    
    # ============================================
    # 重采样参数 (粒子位置更新方差)
    # ============================================
    resample_var_x: 0.1                 # X重采样方差（米²）
    resample_var_y: 0.1                 # Y重采样方差（米²）
    resample_var_z: 0.3                 # Z重采样方差（米²）
    resample_var_yaw: 0.05              # Yaw重采样方差（弧度²）
    resample_var_pitch: 0.05            # Pitch重采样方差（弧度²）
    resample_var_roll: 0.05             # Roll重采样方差（弧度²）
    
    # ============================================
    # 扩展参数 (处理不确定性)
    # ============================================
    expansion_var_x: 0.2                # X扩展方差（米²）
    expansion_var_y: 0.2                # Y扩展方差（米²）
    expansion_var_z: 0.2                # Z扩展方差（米²）
    expansion_var_roll: 0.05            # Roll扩展方差（弧度²）
    expansion_var_pitch: 0.05           # Pitch扩展方差（弧度²）
    expansion_var_yaw: 0.05             # Yaw扩展方差（弧度²）
    
    # ============================================
    # 点云匹配参数
    # ============================================
    match_ratio_thresh: 0.0             # 匹配比例阈值（0-1）
                                        # 0.0 = 接受所有匹配
                                        # 建议: 0.0-0.3
    
    # ============================================
    # 聚类参数 (特征点聚类)
    # ============================================
    euc_cluster_distance: 0.8           # 欧氏距离聚类阈值（米）
    euc_cluster_min_size: 3             # 聚类最小点数
    
    # ============================================
    # KNN搜索参数 (地面法向量计算)
    # ============================================
    knn_num_of_ground_normals: 20       # KNN邻域大小（用于法向量估计）
    
    # ============================================
    # 粒子更新参数 (定位精度控制)
    # ============================================
    update_min_d: 0.1                   # 最小线性位移触发更新（米）
    update_min_a: 0.1                   # 最小角位移触发更新（弧度）
    
    # ============================================
    # 里程计误差模型 (影响粒子扩散速度)
    # ============================================
    odom_err_lin_lin: 0.10              # 线性运动的线性误差比例
    odom_err_lin_ang: 0.05              # 线性运动的角误差比例
    odom_err_ang_lin: 0.05              # 角运动的线性误差比例
    odom_err_ang_ang: 0.05              # 角运动的角误差比例

# ============================================
# 参数调优建议
# ============================================
# 
# 1. 如果定位不稳定/漂移快:
#    - 增加 num_particles: 300-500
#    - 增加 init_var_x/y: 3.0-5.0
#    - 检查里程计精度 (查看 /tf 变换)
#
# 2. 如果定位过度收敛（粒子聚集）:
#    - 增加 resample_var_* 参数
#    - 增加 expansion_var_* 参数
#    - 减少 match_ratio_thresh 严格程度
#
# 3. 如果点云匹配效果差:
#    - 调整 euc_cluster_distance: 0.5-1.5
#    - 调整 knn_num_of_ground_normals: 10-30
#
# 4. 性能优化 (CPU负载过高):
#    - 减少 num_particles: 100
#    - 增加 map_downsample_*: 0.2
#    - 增加 map_update_interval_sec: 2-5
#
