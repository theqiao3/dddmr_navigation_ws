# MCL 3DL 配置文件 - lego_map专用版本
# 针对DDDMR使用lego_map文件夹中生成的地图进行定位
# 
# 使用此配置启动:
# ros2 launch mcl_3dl mcl_3dl_lego_map.launch.py \
#     config_file:=/path/to/mcl_3dl_lego_map.yaml

# ============================================
# 子地图配置
# ============================================
sub_maps:
  ros__parameters:
    # 子地图目录 - 指向lego_map/pcd/
    # 包含: 0_feature.pcd, 0_ground.pcd, 0_surface.pcd 等
    pose_graph_dir: "/home/tianbot/dddmr_navigation_ws/src/lego_map/pcd"
    
    # 子地图搜索范围（米）
    # 适用于中等规模场景（<100m²）
    sub_map_search_radius: 50.0
    
    # 触发子地图预热的距离（米）
    # 当机器人移动超过此距离时,预加载附近的子地图
    sub_map_warmup_trigger_distance: 20.0
    
    # 完整地图体素尺寸（米）
    # 地图融合时的分辨率,影响计算速度和内存占用
    complete_map_voxel_size: 0.25

# ============================================
# MCL 3DL主要参数
# ============================================
mcl_3dl:
  ros__parameters:
    # ============================================
    # 1. 初始位置估计
    # ============================================
    # 机器人初始位置（米和弧度）
    # 建议: 根据实际建图时的起点设置
    init_x: 0.0                         # 初始X位置
    init_y: 0.0                         # 初始Y位置
    init_z: 0.0                         # 初始Z位置（通常为0）
    init_roll: 0.0                      # 初始Roll角（绕X轴旋转）
    init_pitch: 0.0                     # 初始Pitch角（绕Y轴旋转）
    init_yaw: 0.0                       # 初始Yaw角（绕Z轴旋转，单位:弧度）
    
    # ============================================
    # 2. 初始不确定度
    # ============================================
    # 影响初始粒子的分布范围
    # 值越大,粒子分布范围越大,收敛速度越慢
    # 值越小,粒子分布范围越小,可能遗漏真实位置
    
    init_var_x: 2.0                     # X方向初始方差（米²）
    init_var_y: 2.0                     # Y方向初始方差（米²）
    init_var_z: 3.0                     # Z方向初始方差（米²）
    init_var_roll: 0.1                  # Roll初始方差（弧度²）
    init_var_pitch: 0.1                 # Pitch初始方差（弧度²）
    init_var_yaw: 0.5                   # Yaw初始方差（弧度²）
                                        # 对应约28.6度的标准差
    
    # ============================================
    # 3. 坐标系设置
    # ============================================
    # 必须与TF树配置一致
    map_frame: "map"                    # 地图坐标系名称
    robot_frame: "base_link"            # 机器人基座坐标系名称
    odom_frame: "odom"                  # 里程计坐标系名称
    
    # ============================================
    # 4. 地图下采样 - 性能调优
    # ============================================
    # 地图点云下采样分辨率（米）
    # 越小 = 点数越多 = 定位精度↑ 但CPU↑
    # 越大 = 点数越少 = CPU↓ 但精度↓
    
    map_downsample_x: 0.1               # X方向下采样分辨率
    map_downsample_y: 0.1               # Y方向下采样分辨率
    map_downsample_z: 0.1               # Z方向下采样分辨率
    
    # 地图更新间隔（秒）
    # 控制地图点云的更新频率
    # 建议: 1-2秒（高频更新会增加CPU负载）
    map_update_interval_sec: 1
    
    # ============================================
    # 5. 粒子滤波配置
    # ============================================
    # 粒子数量 - 关键参数,影响定位精度和计算速度
    num_particles: 200                  
    # 建议值:
    #   - 小场景(<50m²): 100-200
    #   - 中场景(50-200m²): 200-500  <- 当前配置适合
    #   - 大场景(>200m²): 500-1000
    #   - 高精度要求: 1000-2000
    # 
    # 注意: 粒子数↑ = 精度↑ 但 CPU↑
    
    # ============================================
    # 6. 重采样参数 - 粒子位置更新
    # ============================================
    # 重采样时,新粒子位置的随机扰动方差
    # 用于处理模型不确定性和传感器噪声
    
    resample_var_x: 0.1                 # X重采样方差（米²）
    resample_var_y: 0.1                 # Y重采样方差（米²）
    resample_var_z: 0.3                 # Z重采样方差（米²）
                                        # Z通常设置较大(3倍)
    resample_var_yaw: 0.05              # Yaw重采样方差（弧度²）
                                        # 对应约7.2度标准差
    resample_var_pitch: 0.05            # Pitch重采样方差（弧度²）
    resample_var_roll: 0.05             # Roll重采样方差（弧度²）
    
    # ============================================
    # 7. 扩展参数 - 处理不确定性
    # ============================================
    # 粒子扩散参数,用于处理模型的未建模动力学
    # 值越大,粒子扩散越快,抗干扰能力越强
    # 但可能导致定位精度下降
    
    expansion_var_x: 0.2                # X扩展方差（米²）
    expansion_var_y: 0.2                # Y扩展方差（米²）
    expansion_var_z: 0.2                # Z扩展方差（米²）
    expansion_var_roll: 0.05            # Roll扩展方差（弧度²）
    expansion_var_pitch: 0.05           # Pitch扩展方差（弧度²）
    expansion_var_yaw: 0.05             # Yaw扩展方差（弧度²）
    
    # ============================================
    # 8. 点云匹配参数
    # ============================================
    # 匹配比例阈值（0-1之间）
    # 0.0 = 接受所有匹配（容错)
    # 1.0 = 只接受完美匹配（严格）
    # 建议: 0.0-0.3（平衡精度和容错）
    match_ratio_thresh: 0.0
    
    # ============================================
    # 9. 欧氏距离聚类参数
    # ============================================
    # 用于将相近的点云簇聚类到一起
    
    # 聚类的距离阈值（米）
    # 距离<此值的点被认为属于同一聚类
    euc_cluster_distance: 0.8           # 范围: 0.5-1.5米
                                        # 当前值适合室内环境
    
    # 聚类的最小点数
    # 点数少于此值的聚类被过滤掉
    euc_cluster_min_size: 3             # 范围: 2-5个点
    
    # ============================================
    # 10. KNN搜索参数 - 法向量估计
    # ============================================
    # 用于地面检测和特征计算
    knn_num_of_ground_normals: 20       # 邻域大小（个点）
                                        # 范围: 10-30
                                        # 值越大 = 法向量估计越平滑
    
    # ============================================
    # 11. 粒子更新触发参数
    # ============================================
    # 控制何时更新粒子权重
    
    # 最小线性位移触发更新（米）
    update_min_d: 0.1                   # 移动超过0.1m触发更新
                                        # 范围: 0.05-0.2m
    
    # 最小角位移触发更新（弧度）
    update_min_a: 0.1                   # 旋转超过0.1rad(5.7°)触发更新
                                        # 范围: 0.05-0.2rad
    
    # ============================================
    # 12. 里程计误差模型
    # ============================================
    # 描述里程计误差如何随着运动增长
    # 公式: position_error = 
    #       odom_err_lin_lin * linear_distance +
    #       odom_err_lin_ang * angular_distance
    
    odom_err_lin_lin: 0.10              # 线性运动的线性误差比例
                                        # 1%的平移误差
    odom_err_lin_ang: 0.05              # 线性运动的角误差比例
                                        # 5%的旋转误差
    odom_err_ang_lin: 0.05              # 角运动的线性误差比例
    odom_err_ang_ang: 0.05              # 角运动的角误差比例
    
    # 里程计误差积分时间常数（秒）
    odom_err_integ_lin_tc: 10.0         # 线性误差积分时间
    odom_err_integ_ang_tc: 10.0         # 角误差积分时间
    
    # ============================================
    # 13. 低通滤波参数
    # ============================================
    # 用于平滑粒子的位置估计
    
    # 位置低通滤波步长
    lpf_step: 10.0                      # 范围: 5-20
                                        # 值越大,滤波效果越强
    
    # 加速度低通滤波步长
    acc_lpf_step: 128.0                 # 范围: 64-256
    
    # ============================================
    # 14. 跳跃检测参数
    # ============================================
    # 用于检测异常的粗大误差（跳跃）
    
    # 距离跳跃阈值（米）
    jump_dist: 1.0                      # 超过1m的瞬间移动被视为跳跃
    
    # 角度跳跃阈值（弧度）
    jump_ang: 1.57                      # 超过π/2(90°)的瞬间旋转被视为跳跃
    
    # ============================================
    # 15. 偏差估计参数
    # ============================================
    # 用于估计里程计的系统偏差
    
    bias_var_dist: 2.0                  # 距离偏差的初始方差
    bias_var_ang: 1.57                  # 角度偏差的初始方差
    
    # ============================================
    # 16. TF发布设置
    # ============================================
    # TF发布的时间容限（秒）
    tf_tolerance: 0.1                   # 允许0.1秒的时间偏差
    
    # 是否发布TF变换
    publish_tf: true                    # true = 发布map->odom变换
                                        # false = 不发布(由其他节点发布)
    
    # ============================================
    # 17. 似然函数配置
    # ============================================
    likelihood:
      # 全局搜索的点数
      num_points_global: 100            # 范围: 50-200
                                        # 用于与全局地图匹配
      
      # 最小匹配距离（米）
      match_dist_min: 1.0               # 距离<1m则认为是好匹配
      
      # 平面区域的匹配距离（米）
      match_dist_flat: 0.05             # 平面区域匹配更严格
      
      # 地面点数阈值
      threshold_for_trusted_ground: 100000  # 地面点数>100K时信任地面估计
      
      # 地面搜索半径（米）
      radius_of_ground_search: 1.0      # 在1m范围内搜索地面

# ============================================
# 参数快速调优建议
# ============================================
#
# 问题1: 定位不稳定、漂移快
#   解决方案:
#   - 增加 num_particles: 300-500
#   - 增加 init_var_x/y: 3.0-5.0
#   - 检查里程计精度: ros2 topic echo /tf
#
# 问题2: 定位过度收敛（粒子聚集到一个点）
#   解决方案:
#   - 增加 resample_var_* 参数 (×1.5)
#   - 增加 expansion_var_* 参数 (×1.5)
#   - 放宽 match_ratio_thresh: 0.1-0.3
#
# 问题3: 定位初始化时间过长
#   解决方案:
#   - 减少 num_particles: 100-150
#   - 减少 map_downsample_*: 0.2
#   - 增加 map_update_interval_sec: 2-3
#
# 问题4: 点云匹配效果差
#   解决方案:
#   - 调整 euc_cluster_distance: 0.5-1.5
#   - 调整 knn_num_of_ground_normals: 15-30
#   - 检查地面点云质量
#
# 问题5: 关键场景(走廊、重复纹理)定位失效
#   解决方案:
#   - 增加 num_points_global: 150-200
#   - 放宽 match_dist_min: 1.5-2.0
#   - 增加 nearest_feature_search_distance
#
